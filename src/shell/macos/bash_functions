#!/bin/bash

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Change working directory to the top-most Finder window location

cdf() { # short for `cdfinder`
	cd "$(osascript -e 'tell app "Finder" to POSIX path of (insertion location as alias)')" || return;
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Switch Audio

function headset() {
	switchaudiosource -t input -s "External Headphones"
	switchaudiosource -t output -s "External Headphones"
}

function speakers() {
    switchaudiosource -t input -s "MacBook Pro Microphone"
    switchaudiosource -t output -s "MacBook Pro Speakers"
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Toggle bluetooth devices

function bu () {
    device_name=$1
    declare device_mac_id

    if [[ $device_name = "trackpad" ]]
    then
        device_mac_id="f4-1b-a1-30-7d-87"
    elif [[ $device_name = "speakers" ]]
    then
        device_mac_id="00-11-67-c7-5e-78"
    elif [[ $device_name = "keyboard" ]]
    then
        device_mac_id="b8-f6-b1-0c-c2-1e"
    else
        echo "Unknown device: $device_name"
        return
    fi

    toggle_bt_device "$device_mac_id"
}

function toggle_bt_device() {
    mac_addr=$1
    pin=$2

    if [[ $(blueutil --is-connected "$mac_addr") = '1' ]]
    then
        echo Disconnecting "$mac_addr"
        blueutil --unpair "$mac_addr"
    else
        echo Reconnecting "$mac_addr"
        blueutil --unpair "$mac_addr"
        sleep 1

        if [[ -n "$pin" ]]
        then
            blueutil --pair "$mac_addr" "$pin"
        else
            blueutil --pair "$mac_addr"
        fi

        blueutil --pair "$mac_addr"
        sleep 1

        blueutil --connect "$mac_addr"
    fi
}



# Synchronise Litra Glow settings before delegating to the real binary
function litra() {
    local litra_bin
    litra_bin="${LITRA_BIN:-$(type -P litra)}"

    if [[ -z "$litra_bin" ]]; then
        echo "Unable to locate the Litra CLI binary" >&2
        return 1
    fi

    if [[ $# -eq 0 ]]; then
        "$litra_bin"
        return $?
    fi

    local command="$1"
    shift

    if [[ "$command" == "toggle" ]]; then
        local has_target=false
        local arg

        for arg in "$@"; do
            case "$arg" in
                --serial-number|--device-path|--device-type|-s|-p|-t|\
                --serial-number=*|--device-path=*|--device-type=*)
                    has_target=true
                    break
                    ;;
            esac
        done

        if [[ "$has_target" == false ]] && command -v jq >/dev/null 2>&1; then
            local devices_json
            if devices_json="$("$litra_bin" devices --json 2>/dev/null)"; then
                local device_rows first_row second_row
                device_rows=$(printf '%s\n' "$devices_json" | jq -r '[.[] | select((.device_type // "") | ascii_downcase | startswith("litra"))][:2][] | [.serial_number, (.brightness_in_lumen // ""), (.temperature_in_kelvin // "")] | @tsv')
                first_row=$(printf '%s\n' "$device_rows" | sed -n '1p')
                second_row=$(printf '%s\n' "$device_rows" | sed -n '2p')

                if [[ -n "$first_row" && -n "$second_row" ]]; then
                    local first_serial first_brightness first_temperature second_serial tab
                    tab=$'\t'
                    IFS=$'\t' read -r first_serial first_brightness first_temperature <<<"$first_row"
                    second_serial=${second_row%%"$tab"*}

                    if [[ -n "$first_serial" && -n "$second_serial" && "$first_serial" != "$second_serial" ]]; then
                        if [[ -n "$first_brightness" ]]; then
                            "$litra_bin" brightness --serial-number "$second_serial" --value "$first_brightness" >/dev/null 2>&1 || echo "Warning: failed to copy brightness to $second_serial" >&2
                        fi

                        if [[ -n "$first_temperature" ]]; then
                            "$litra_bin" temperature --serial-number "$second_serial" --value "$first_temperature" >/dev/null 2>&1 || echo "Warning: failed to copy temperature to $second_serial" >&2
                        fi
                    fi
                fi
            fi
        fi
    fi

    "$litra_bin" "$command" "$@"
}


